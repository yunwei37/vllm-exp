{
  "issue_type": "bug",
  "extracted_from": "/root/yunwei37/vllm-exp/bug-study/analysis_llm/sample_results/vllm/label_based/bug/issues.json",
  "issue": {
    "number": 16911,
    "title": "[Bug]: guided_grammar example syntax does not work",
    "body": "### Your current environment\n\nI'm using vllm hosted on a K8s instance and was not able to execute the environment collection python file there. But this is the error I get:\n\n<details>\n<summary>Error message</summary>\n\n```\nINFO 04-21 00:33:45 [loggers.py:87] Engine 000: Avg prompt throughput: 0.0 tokens/s, Avg generation throughput: 0.0 tokens/s, Running: 0 reqs, Waiting: 0 reqs, GPU KV cache usage: 0.0%, Prefix cache hit rate: 66.7%                                                                                  \nINFO 04-21 00:33:55 [logger.py:39] Received request chatcmpl-5a7a5fbaada34f3a88b577a238ddd279: prompt: \"<|im_start|>system\\nYou are a helpful assistant.<|im_end|>\\n<|im_start|>user\\nGenerate an SQL query to show the 'username' and 'email'from the 'users' table.<|im_end|>\\n<|im_start|>assistant\\ \nINFO 04-21 00:33:55 [async_llm.py:228] Added request chatcmpl-5a7a5fbaada34f3a88b577a238ddd279.                                                                                                                                                                                                         \nERROR 04-21 00:33:55 [core.py:387] EngineCore hit an exception: Traceback (most recent call last):                                                                                                                                                                                                      \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/vllm/v1/engine/core.py\", line 380, in run_engine_core                                                                                                                                                                \nERROR 04-21 00:33:55 [core.py:387]     engine_core.run_busy_loop()                                                                                                                                                                                                                                      \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/vllm/v1/engine/core.py\", line 402, in run_busy_loop                                                                                                                                                                  \nERROR 04-21 00:33:55 [core.py:387]     self._process_engine_step()                                                                                                                                                                                                                                      \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/vllm/v1/engine/core.py\", line 431, in _process_engine_step                                                                                                                                                           \nERROR 04-21 00:33:55 [core.py:387]     outputs = self.step_fn()                                                                                                                                                                                                                                         \nERROR 04-21 00:33:55 [core.py:387]               ^^^^^^^^^^^^^^                                                                                                                                                                                                                                         \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/vllm/v1/engine/core.py\", line 206, in step                                                                                                                                                                           \nERROR 04-21 00:33:55 [core.py:387]     scheduler_output = self.scheduler.schedule()                                                                                                                                                                                                                     \nERROR 04-21 00:33:55 [core.py:387]                        ^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                                                                                     \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/vllm/v1/core/sched/scheduler.py\", line 286, in schedule                                                                                                                                                              \nERROR 04-21 00:33:55 [core.py:387]     if structured_output_req and structured_output_req.grammar:                                                                                                                                                                                                      \nERROR 04-21 00:33:55 [core.py:387]                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                                                                       \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/vllm/v1/structured_output/request.py\", line 43, in grammar                                                                                                                                                           \nERROR 04-21 00:33:55 [core.py:387]     completed = self._check_grammar_completion()                                                                                                                                                                                                                     \nERROR 04-21 00:33:55 [core.py:387]                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                                                                                     \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/vllm/v1/structured_output/request.py\", line 31, in _check_grammar_completion                                                                                                                                         \nERROR 04-21 00:33:55 [core.py:387]     self._grammar = self._grammar.result(timeout=0.0001)                                                                                                                                                                                                             \nERROR 04-21 00:33:55 [core.py:387]                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                                                                             \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/lib/python3.12/concurrent/futures/_base.py\", line 456, in result                                                                                                                                                                                        \nERROR 04-21 00:33:55 [core.py:387]     return self.__get_result()                                                                                                                                                                                                                                       \nERROR 04-21 00:33:55 [core.py:387]            ^^^^^^^^^^^^^^^^^^^                                                                                                                                                                                                                                       \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result                                                                                                                                                                                  \nERROR 04-21 00:33:55 [core.py:387]     raise self._exception                                                                                                                                                                                                                                            \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/lib/python3.12/concurrent/futures/thread.py\", line 59, in run                                                                                                                                                                                           \nERROR 04-21 00:33:55 [core.py:387]     result = self.fn(*self.args, **self.kwargs)                                                                                                                                                                                                                      \nERROR 04-21 00:33:55 [core.py:387]              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                                                                                      \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/vllm/v1/structured_output/__init__.py\", line 77, in _async_create_grammar                                                                                                                                            \nERROR 04-21 00:33:55 [core.py:387]     return self.backend.compile_grammar(request_type, grammar_spec)                                                                                                                                                                                                  \nERROR 04-21 00:33:55 [core.py:387]            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                                                                  \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/vllm/v1/structured_output/backend_xgrammar.py\", line 97, in compile_grammar                                                                                                                                          \nERROR 04-21 00:33:55 [core.py:387]     ctx = self.compiler.compile_grammar(grammar_spec)                                                                                                                                                                                                                \nERROR 04-21 00:33:55 [core.py:387]           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                                                                                \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/xgrammar/compiler.py\", line 211, in compile_grammar                                                                                                                                                                  \nERROR 04-21 00:33:55 [core.py:387]     grammar = Grammar.from_ebnf(grammar, root_rule_name=root_rule_name)                                                                                                                                                                                              \nERROR 04-21 00:33:55 [core.py:387]               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                                                              \nERROR 04-21 00:33:55 [core.py:387]   File \"/usr/local/lib/python3.12/dist-packages/xgrammar/grammar.py\", line 110, in from_ebnf                                                                                                                                                                         \nERROR 04-21 00:33:55 [core.py:387]     return Grammar._create_from_handle(_core.Grammar.from_ebnf(ebnf_string, root_rule_name))                                                                                                                                                                         \nERROR 04-21 00:33:55 [core.py:387]                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                                          \nERROR 04-21 00:33:55 [core.py:387] RuntimeError: [00:33:55] /project/cpp/grammar_parser.cc:78: EBNF parse error at line 2, column 5: Expect rule name                                                                                                                                                   \nERROR 04-21 00:33:55 [core.py:387]                                                                                                                                                                                                                                                                      \nERROR 04-21 00:33:55 [core.py:387]                                                                                                                                                                                                                                                                      \nCRITICAL 04-21 00:33:55 [core_client.py:359] Got fatal signal from worker processes, shutting down. See stack trace above for root cause issue.                                                                                                                                                         \nKilled                                                                                                                                                                                                                                                                                                  \nstream closed EOF for s92818/vllm-deployment-openai-768966b6df-fmrwx (vllm-deployment-openai)  \n```\n\n</details>\n\n\n### \ud83d\udc1b Describe the bug\n\n\nI'm trying to use guided grammar as found in [documentation](https://docs.vllm.ai/en/latest/features/structured_outputs.html). All examples about structured outputs worked as presented but the one with EBNF. I tried to remove the tabstops in front of the lines, to rename the start node to root but it did not help.\n\n```\nwrong_simplified_sql_grammar = \"\"\"\n?start: select_statement\n?select_statement: \"SELECT \" column_list \" FROM \" table_name\n?column_list: column_name (\",\" column_name)*\n?table_name: identifier\n?column_name: identifier\n?identifier: /[a-zA-Z_][a-zA-Z0-9_]*/\n\"\"\"\n\nprompt = (\"Generate an SQL query to show the 'username' and 'email'\"\n          \"from the 'users' table.\")\ncompletion = client.chat.completions.create(\n    model=\"Qwen/Qwen2.5-7B\",\n    messages=[{\n        \"role\": \"user\",\n        \"content\": prompt,\n    }],\n    extra_body={\n        \"guided_grammar\": wrong_simplified_sql_grammar\n        },\n)\nprint(completion.choices[0].message.content)\n```\n\nBecause I got some messages about wrong escape sequences in other examples I added an r in front of the string. But then the `?` at the line start get formatted. Looking at the [EBNF documentation of xgrammar](https://xgrammar.mlc.ai/docs/how_to/ebnf_guided_generation.html) made me reformulate the grammar as following and it worked:\n\n```\nsimplified_sql_grammar = r\"\"\"\nroot ::= select_statement\nselect_statement ::= \"SELECT \" column_list \" FROM \" table_name\ncolumn_list ::= column_name (\", \" column_name)*\ntable_name ::= identifier\ncolumn_name ::= identifier\nidentifier ::= [a-zA-Z_][a-zA-Z_]*\n\"\"\"\n```\n\nNaming the first node `root` seems to be obligatory. The `/` in `/[a-zA-Z_][a-zA-Z_]*/` will kill the deployment as well.\n\nI was not able to try it with the transformers locally yet. But even though it would not work their either I think the documentation for vllm might have to be adjusted.\n\n### Before submitting a new issue...\n\n- [x] Make sure you already searched for relevant issues, and asked the chatbot living at the bottom right corner of the [documentation page](https://docs.vllm.ai/en/latest/), which can answer lots of frequently asked questions.",
    "labels": [
      "bug",
      "structured-output"
    ],
    "state": "open",
    "created_at": "2025-04-21T08:13:48+00:00",
    "closed_at": null,
    "comments": 0,
    "reactions": {
      "url": "https://api.github.com/repos/vllm-project/vllm/issues/16911/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "author_association": "NONE",
    "html_url": "https://github.com/vllm-project/vllm/issues/16911"
  }
}