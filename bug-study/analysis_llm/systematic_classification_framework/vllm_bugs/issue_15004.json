{
  "issue_type": "bug",
  "extracted_from": "/root/yunwei37/vllm-exp/bug-study/analysis_llm/sample_results/vllm/label_based/bug/issues.json",
  "issue": {
    "number": 15004,
    "title": "[Bug]:  Failed to Run Qwen2.5-7B with RTX 3070 & CPU Offload (14GB) Despite Sufficient Theoretical Memory",
    "body": "### Your current environment\n\nThe output of `python collect_env.py`\n(vllm) roy@Roy-L:~/projects$ python collect_env.py\nINFO 03-12 13:15:42 __init__.py:207] Automatically detected platform cuda.\nCollecting environment information...\nPyTorch version: 2.5.1+cu124\nIs debug build: False\nCUDA used to build PyTorch: 12.4\nROCM used to build PyTorch: N/A\n\nOS: Ubuntu 22.04.5 LTS (x86_64)\nGCC version: (Ubuntu 12.3.0-1ubuntu1~22.04) 12.3.0\nClang version: Could not collect\nCMake version: version 3.22.1\nLibc version: glibc-2.35\n\nPython version: 3.12.9 | packaged by Anaconda, Inc. | (main, Feb  6 2025, 18:56:27) [GCC 11.2.0] (64-bit runtime)\nPython platform: Linux-5.15.167.4-microsoft-standard-WSL2-x86_64-with-glibc2.35\nIs CUDA available: True\nCUDA runtime version: 12.8.61\nCUDA_MODULE_LOADING set to: LAZY\nGPU models and configuration: GPU 0: NVIDIA GeForce RTX 3070 Laptop GPU\nNvidia driver version: 572.70\ncuDNN version: Could not collect\nHIP runtime version: N/A\nMIOpen runtime version: N/A\nIs XNNPACK available: True\n\nCPU:\nArchitecture:                         x86_64\nCPU op-mode(s):                       32-bit, 64-bit\nAddress sizes:                        48 bits physical, 48 bits virtual\nByte Order:                           Little Endian\nCPU(s):                               16\nOn-line CPU(s) list:                  0-15\nVendor ID:                            AuthenticAMD\nModel name:                           AMD Ryzen 7 5800H with Radeon Graphics\nCPU family:                           25\nModel:                                80\nThread(s) per core:                   2\nCore(s) per socket:                   8\nSocket(s):                            1\nStepping:                             0\nBogoMIPS:                             6387.84\nFlags:                                fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc rep_good nopl tsc_reliable nonstop_tsc cpuid extd_apicid pni pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 movbe popcnt aes xsave avx f16c rdrand hypervisor lahf_lm cmp_legacy svm cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw topoext perfctr_core ssbd ibrs ibpb stibp vmmcall fsgsbase bmi1 avx2 smep bmi2 erms invpcid rdseed adx smap clflushopt clwb sha_ni xsaveopt xsavec xgetbv1 xsaves clzero xsaveerptr arat npt nrip_save tsc_scale vmcb_clean flushbyasid decodeassists pausefilter pfthreshold v_vmsave_vmload umip vaes vpclmulqdq rdpid fsrm\nVirtualization:                       AMD-V\nHypervisor vendor:                    Microsoft\nVirtualization type:                  full\nL1d cache:                            256 KiB (8 instances)\nL1i cache:                            256 KiB (8 instances)\nL2 cache:                             4 MiB (8 instances)\nL3 cache:                             16 MiB (1 instance)\nVulnerability Gather data sampling:   Not affected\nVulnerability Itlb multihit:          Not affected\nVulnerability L1tf:                   Not affected\nVulnerability Mds:                    Not affected\nVulnerability Meltdown:               Not affected\nVulnerability Mmio stale data:        Not affected\nVulnerability Reg file data sampling: Not affected\nVulnerability Retbleed:               Not affected\nVulnerability Spec rstack overflow:   Mitigation; safe RET\nVulnerability Spec store bypass:      Mitigation; Speculative Store Bypass disabled via prctl and seccomp\nVulnerability Spectre v1:             Mitigation; usercopy/swapgs barriers and __user pointer sanitization\nVulnerability Spectre v2:             Mitigation; Retpolines; IBPB conditional; IBRS_FW; STIBP conditional; RSB filling; PBRSB-eIBRS Not affected; BHI Not affected\nVulnerability Srbds:                  Not affected\nVulnerability Tsx async abort:        Not affected\n\nVersions of relevant libraries:\n[pip3] numpy==1.26.4\n[pip3] nvidia-cublas-cu12==12.4.5.8\n[pip3] nvidia-cuda-cupti-cu12==12.4.127\n[pip3] nvidia-cuda-nvrtc-cu12==12.4.127\n[pip3] nvidia-cuda-runtime-cu12==12.4.127\n[pip3] nvidia-cudnn-cu12==9.1.0.70\n[pip3] nvidia-cufft-cu12==11.2.1.3\n[pip3] nvidia-curand-cu12==10.3.5.147\n[pip3] nvidia-cusolver-cu12==11.6.1.9\n[pip3] nvidia-cusparse-cu12==12.3.1.170\n[pip3] nvidia-nccl-cu12==2.21.5\n[pip3] nvidia-nvjitlink-cu12==12.4.127\n[pip3] nvidia-nvtx-cu12==12.4.127\n[pip3] pyzmq==26.2.1\n[pip3] torch==2.5.1\n[pip3] torchaudio==2.5.1\n[pip3] torchvision==0.20.1\n[pip3] transformers==4.49.0\n[pip3] triton==3.1.0\n[conda] numpy                     1.26.4                   pypi_0    pypi\n[conda] nvidia-cublas-cu12        12.4.5.8                 pypi_0    pypi\n[conda] nvidia-cuda-cupti-cu12    12.4.127                 pypi_0    pypi\n[conda] nvidia-cuda-nvrtc-cu12    12.4.127                 pypi_0    pypi\n[conda] nvidia-cuda-runtime-cu12  12.4.127                 pypi_0    pypi\n[conda] nvidia-cudnn-cu12         9.1.0.70                 pypi_0    pypi\n[conda] nvidia-cufft-cu12         11.2.1.3                 pypi_0    pypi\n[conda] nvidia-curand-cu12        10.3.5.147               pypi_0    pypi\n[conda] nvidia-cusolver-cu12      11.6.1.9                 pypi_0    pypi\n[conda] nvidia-cusparse-cu12      12.3.1.170               pypi_0    pypi\n[conda] nvidia-nccl-cu12          2.21.5                   pypi_0    pypi\n[conda] nvidia-nvjitlink-cu12     12.4.127                 pypi_0    pypi\n[conda] nvidia-nvtx-cu12          12.4.127                 pypi_0    pypi\n[conda] pyzmq                     26.2.1                   pypi_0    pypi\n[conda] torch                     2.5.1                    pypi_0    pypi\n[conda] torchaudio                2.5.1                    pypi_0    pypi\n[conda] torchvision               0.20.1                   pypi_0    pypi\n[conda] transformers              4.49.0                   pypi_0    pypi\n[conda] triton                    3.1.0                    pypi_0    pypi\nROCM Version: Could not collect\nNeuron SDK Version: N/A\nvLLM Version: 0.7.3\nvLLM Build Flags:\nCUDA Archs: Not Set; ROCm: Disabled; Neuron: Disabled\nGPU Topology:\nGPU0    CPU Affinity    NUMA Affinity   GPU NUMA ID\nGPU0     X                              N/A\n\nLegend:\n\n  X    = Self\n  SYS  = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI)\n  NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node\n  PHB  = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU)\n  PXB  = Connection traversing multiple PCIe bridges (without traversing the PCIe Host Bridge)\n  PIX  = Connection traversing at most a single PCIe bridge\n  NV#  = Connection traversing a bonded set of # NVLinks\n\nLD_LIBRARY_PATH=/home/roy/miniconda3/envs/vllm/lib/python3.12/site-packages/cv2/../../lib64:/usr/local/cuda-12.8/lib64:/usr/local/cuda-12.8/lib64:/usr/local/cuda-12.8/lib64:\nVLLM_USE_V1=1\nNCCL_CUMEM_ENABLE=0\nTORCHINDUCTOR_COMPILE_THREADS=1\nCUDA_MODULE_LOADING=LAZY\n\n### \ud83d\udc1b Describe the bug\n\nI'm using WSL2. When attempting to run \u200bQwen2.5-7B using vLLM 0.7.3 with CPU offloading, the initialization fails with ValueError: No available memory for the cache blocks, despite having:\n\n32GB system RAM (14GB allocated via cpu_offload_gb) (\"I have tried the cpu_offload_gb parameter in the range of 10 to 22, but none of these settings allowed the model to run successfully.\")\n8GB NVIDIA RTX 3070 GPU\nTheoretical memory requirements (14GB offloaded to RAM + ~ 8*0.9(gpu_memory_utilization)=7.2GB VRAM ) appear compatible with hardware specs, but practical allocation fails.\n\nThe code is simple:\n`\nfrom transformers import AutoTokenizer\nfrom vllm import LLM, SamplingParams\n\ntokenizer = AutoTokenizer.from_pretrained(\"/home/roy/models/Qwen2.5-7B\")\n\nsampling_params = SamplingParams(temperature=0.7, top_p=0.8, repetition_penalty=1.05, max_tokens=256)\n\nllm = LLM(model=\"/home/roy/models/Qwen2.5-7B\", max_model_len = 512, cpu_offload_gb= 12,gpu_memory_utilization=0.95)\n\nprompt = \"Tell me something about large language models.\"\nmessages = [\n{\"role\": \"system\", \"content\": \"You are Qwen, created by Alibaba Cloud. You are a helpful assistant.\"},\n{\"role\": \"user\", \"content\": prompt}\n]\ntext = tokenizer.apply_chat_template(\nmessages,\ntokenize=False,\nadd_generation_prompt=True\n)\n\noutputs = llm.generate([text], sampling_params)\n\nfor output in outputs:\nprompt = output.prompt\ngenerated_text = output.outputs[0].text\nprint(f\"Prompt: {prompt!r}, Generated text: {generated_text!r}\")\n`\n\nError log here:\n(vllm) (base) roy@Roy-L:~/projects$ /home/roy/miniconda3/envs/vllm/bin/python /home/roy/projects/test/test_qwen7b\nINFO 03-18 13:04:44 init.py:207] Automatically detected platform cuda.\nWARNING 03-18 13:04:46 arg_utils.py:1385] Setting max_num_batched_tokens to 8192 for LLM_CLASS usage context.\nINFO 03-18 13:04:55 config.py:549] This model supports multiple tasks: {'generate', 'classify', 'reward', 'score', 'embed'}. Defaulting to 'generate'.\nINFO 03-18 13:04:55 config.py:1555] Chunked prefill is enabled with max_num_batched_tokens=8192.\nWARNING 03-18 13:04:55 config.py:3314] CPU offload is not supported with torch.compile yet. Disabling torch.compile.\nINFO 03-18 13:04:56 core.py:50] Initializing a V1 LLM engine (v0.7.3) with config: model='/home/roy/models/Qwen2.5-7B', speculative_config=None, tokenizer='/home/roy/models/Qwen2.5-7B', skip_tokenizer_init=False, tokenizer_mode=auto, revision=None, override_neuron_config=None, tokenizer_revision=None, trust_remote_code=False, dtype=torch.bfloat16, max_seq_len=512, download_dir=None, load_format=LoadFormat.AUTO, tensor_parallel_size=1, pipeline_parallel_size=1, disable_custom_all_reduce=False, quantization=None, enforce_eager=False, kv_cache_dtype=auto, device_config=cuda, decoding_config=DecodingConfig(guided_decoding_backend='xgrammar'), observability_config=ObservabilityConfig(otlp_traces_endpoint=None, collect_model_forward_time=False, collect_model_execute_time=False), seed=0, served_model_name=/home/roy/models/Qwen2.5-7B, num_scheduler_steps=1, multi_step_stream_outputs=True, enable_prefix_caching=True, chunked_prefill_enabled=True, use_async_output_proc=True, disable_mm_preprocessor_cache=False, mm_processor_kwargs=None, pooler_config=None, compilation_config={\"level\":0,\"custom_ops\":[\"none\"],\"splitting_ops\":[\"vllm.unified_attention\",\"vllm.unified_attention_with_output\"],\"use_inductor\":true,\"compile_sizes\":[],\"use_cudagraph\":true,\"cudagraph_num_of_warmups\":1,\"cudagraph_capture_sizes\":[512,504,496,488,480,472,464,456,448,440,432,424,416,408,400,392,384,376,368,360,352,344,336,328,320,312,304,296,288,280,272,264,256,248,240,232,224,216,208,200,192,184,176,168,160,152,144,136,128,120,112,104,96,88,80,72,64,56,48,40,32,24,16,8,4,2,1],\"max_capture_size\":512}\nWARNING 03-18 13:04:56 utils.py:2262] Methods determine_num_available_blocks,device_config,get_cache_block_size_bytes,list_loras,load_config,pin_lora,remove_lora,scheduler_config not implemented in <vllm.v1.worker.gpu_worker.Worker object at 0x7ff7f7abe660>\nWARNING 03-18 13:04:57 interface.py:304] Using 'pin_memory=False' as WSL is detected. This may slow down the performance.\nINFO 03-18 13:04:57 gpu_model_runner.py:1049] Starting to load model /home/roy/models/Qwen2.5-7B...\nINFO 03-18 13:04:57 cuda.py:157] Using Flash Attention backend on V1 engine.\nWARNING 03-18 13:04:58 topk_topp_sampler.py:46] FlashInfer is not available. Falling back to the PyTorch-native implementation of top-p & top-k sampling. For the best performance, please install FlashInfer.\nWARNING 03-18 13:04:58 rejection_sampler.py:47] FlashInfer is not available. Falling back to the PyTorch-native implementation of rejection sampling. For the best performance, please install FlashInfer.\nLoading safetensors checkpoint shards: 0% Completed | 0/4 [00:00<?, ?it/s]\nLoading safetensors checkpoint shards: 25% Completed | 1/4 [00:07<00:22, 7.48s/it]\nLoading safetensors checkpoint shards: 50% Completed | 2/4 [00:13<00:13, 6.68s/it]\nLoading safetensors checkpoint shards: 75% Completed | 3/4 [00:18<00:05, 5.69s/it]\nLoading safetensors checkpoint shards: 100% Completed | 4/4 [00:22<00:00, 4.98s/it]\nLoading safetensors checkpoint shards: 100% Completed | 4/4 [00:22<00:00, 5.50s/it]\n\nINFO 03-18 13:05:21 gpu_model_runner.py:1060] Loading model weights took 14.2487 GB\nERROR 03-18 13:09:10 core.py:291] EngineCore hit an exception: Traceback (most recent call last):\nERROR 03-18 13:09:10 core.py:291] File \"/home/roy/miniconda3/envs/vllm/lib/python3.12/site-packages/vllm/v1/engine/core.py\", line 283, in run_engine_core\nERROR 03-18 13:09:10 core.py:291] engine_core = EngineCoreProc(*args, **kwargs)\nERROR 03-18 13:09:10 core.py:291] ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nERROR 03-18 13:09:10 core.py:291] File \"/home/roy/miniconda3/envs/vllm/lib/python3.12/site-packages/vllm/v1/engine/core.py\", line 238, in init\nERROR 03-18 13:09:10 core.py:291] super().init(vllm_config, executor_class, log_stats)\nERROR 03-18 13:09:10 core.py:291] File \"/home/roy/miniconda3/envs/vllm/lib/python3.12/site-packages/vllm/v1/engine/core.py\", line 59, in init\nERROR 03-18 13:09:10 core.py:291] num_gpu_blocks, num_cpu_blocks = self._initialize_kv_caches(\nERROR 03-18 13:09:10 core.py:291] ^^^^^^^^^^^^^^^^^^^^^^^^^^^\nERROR 03-18 13:09:10 core.py:291] File \"/home/roy/miniconda3/envs/vllm/lib/python3.12/site-packages/vllm/v1/engine/core.py\", line 102, in _initialize_kv_caches\nERROR 03-18 13:09:10 core.py:291] kv_cache_configs = get_kv_cache_configs(vllm_config, kv_cache_specs,\nERROR 03-18 13:09:10 core.py:291] ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nERROR 03-18 13:09:10 core.py:291] File \"/home/roy/miniconda3/envs/vllm/lib/python3.12/site-packages/vllm/v1/core/kv_cache_utils.py\", line 561, in get_kv_cache_configs\nERROR 03-18 13:09:10 core.py:291] check_enough_kv_cache_memory(vllm_config, kv_cache_spec,\nERROR 03-18 13:09:10 core.py:291] File \"/home/roy/miniconda3/envs/vllm/lib/python3.12/site-packages/vllm/v1/core/kv_cache_utils.py\", line 455, in check_enough_kv_cache_memory\nERROR 03-18 13:09:10 core.py:291] raise ValueError(\"No available memory for the cache blocks. \"\nERROR 03-18 13:09:10 core.py:291] ValueError: No available memory for the cache blocks. Try increasing gpu_memory_utilization when initializing the engine.\nERROR 03-18 13:09:10 core.py:291]\nCRITICAL 03-18 13:09:10 core_client.py:191] Got fatal signal from worker processes, shutting down. See stack trace above for root cause issue.\nKilled\n\n### Before submitting a new issue...\n\n- [x] Make sure you already searched for relevant issues, and asked the chatbot living at the bottom right corner of the [documentation page](https://docs.vllm.ai/en/latest/), which can answer lots of frequently asked questions.",
    "labels": [
      "bug",
      "stale"
    ],
    "state": "closed",
    "created_at": "2025-03-18T05:34:12+00:00",
    "closed_at": "2025-07-18T02:28:25+00:00",
    "comments": 2,
    "reactions": {
      "url": "https://api.github.com/repos/vllm-project/vllm/issues/15004/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "author_association": "NONE",
    "html_url": "https://github.com/vllm-project/vllm/issues/15004"
  }
}